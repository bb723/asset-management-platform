{% extends "base.html" %}

{% block title %}Entities - Asset Management Platform{% endblock %}

{% block extra_css %}
<style>
.entity-card-pending {
    opacity: 0.6;
    pointer-events: none;
}

.entity-card-pending .card {
    background-color: #f8f9fa;
    border: 2px dashed #dee2e6;
}

.entity-card-pending .card-title a {
    color: #6c757d !important;
}

.entity-card-pending .btn {
    opacity: 0.5;
}

.entity-card-pending::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 30px;
    height: 30px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #0d6efd;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

.pagination-info {
    color: #6c757d;
    font-size: 0.9rem;
}

.table-responsive {
    overflow-x: auto;
}

.entity-table th {
    white-space: nowrap;
    background-color: #f8f9fa;
    position: sticky;
    top: 0;
    z-index: 10;
}

.entity-table td {
    vertical-align: middle;
}

.search-box {
    max-width: 300px;
}

.positive-value {
    color: #198754;
}

.negative-value {
    color: #dc3545;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-building"></i> Entities</h1>
        <p class="text-muted">Manage property management entities and their buildings</p>
    </div>
    <div class="col-auto">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEntityModal">
            <i class="bi bi-plus-circle"></i> New Entity
        </button>
    </div>
</div>

<!-- Search and Filters -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group search-box">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Search entities...">
        </div>
    </div>
    <div class="col-md-6 text-end">
        <div class="pagination-info" id="paginationInfo">
            Showing <span id="startIndex">0</span> - <span id="endIndex">0</span> of <span id="totalEntities">0</span> entities
        </div>
    </div>
</div>

<!-- Entities Table -->
<div class="card shadow-sm" id="entitiesContainer">
    <div class="card-body p-0">
        {% if entities %}
        <div class="table-responsive">
            <table class="table table-hover entity-table mb-0">
                <thead>
                    <tr>
                        <th>Entity Name</th>
                        <th class="text-center">Buildings</th>
                        <th class="text-end">Portfolio Value</th>
                        <th class="text-end">Total Debt</th>
                        <th class="text-end">Equity</th>
                        <th class="text-end">Annual Cashflow</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="entitiesTableBody">
                    {% for entity in entities %}
                    {% set metrics = entity_metrics.get(entity.entity_id, {}) %}
                    <tr class="entity-row" data-entity-name="{{ entity.name|lower }}" data-entity-description="{{ (entity.description or '')|lower }}">
                        <td>
                            <div>
                                <a href="{{ url_for('view_entity', entity_id=entity.entity_id) }}" class="fw-semibold text-decoration-none">
                                    {{ entity.name }}
                                </a>
                                {% if entity.description %}
                                <div class="text-muted small">{{ entity.description }}</div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-secondary">{{ metrics.get('building_count', 0) }}</span>
                        </td>
                        <td class="text-end">
                            {% set value = metrics.get('total_value', 0) %}
                            {% if value > 0 %}
                                <span class="fw-semibold">${{ "{:,.0f}".format(value) }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% set debt = metrics.get('total_debt', 0) %}
                            {% if debt > 0 %}
                                <span class="text-danger">${{ "{:,.0f}".format(debt) }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% set equity = metrics.get('total_equity', 0) %}
                            {% if equity != 0 %}
                                <span class="{{ 'positive-value' if equity > 0 else 'negative-value' }} fw-semibold">
                                    ${{ "{:,.0f}".format(equity) }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% set cashflow = metrics.get('annual_cashflow', 0) %}
                            {% if cashflow != 0 %}
                                <span class="{{ 'positive-value' if cashflow > 0 else 'negative-value' }} fw-semibold">
                                    ${{ "{:,.0f}".format(cashflow) }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{{ url_for('view_entity', entity_id=entity.entity_id) }}"
                                   class="btn btn-outline-primary"
                                   title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{{ url_for('edit_entity', entity_id=entity.entity_id) }}"
                                   class="btn btn-outline-secondary"
                                   title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{{ url_for('entity_budget', entity_id=entity.entity_id) }}"
                                   class="btn btn-outline-success"
                                   title="Budget">
                                    <i class="bi bi-currency-dollar"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="card-footer bg-white">
            <nav aria-label="Entity pagination">
                <ul class="pagination pagination-sm mb-0 justify-content-center" id="paginationControls">
                    <!-- Pagination will be generated by JavaScript -->
                </ul>
            </nav>
        </div>
        {% else %}
        <div class="p-4">
            <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle"></i> No entities found. <button type="button" class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#createEntityModal">Create your first entity</button>.
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Entity Modal -->
<div class="modal fade" id="createEntityModal" tabindex="-1" aria-labelledby="createEntityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="createEntityModalLabel">
                    <i class="bi bi-plus-circle"></i> Create New Entity
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createEntityForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Entity Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" required maxlength="255">
                        <div class="form-text">The name of the property management entity</div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                        <div class="form-text">Optional description of the entity</div>
                    </div>
                </form>
                <div id="formError" class="alert alert-danger d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="createEntityBtn">
                    <span class="btn-text">
                        <i class="bi bi-check-circle"></i> Create Entity
                    </span>
                    <span class="btn-spinner d-none">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Creating...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Pagination and Search
let currentPage = 1;
let rowsPerPage = 10;
let filteredRows = [];

document.addEventListener('DOMContentLoaded', function() {
    const createEntityBtn = document.getElementById('createEntityBtn');
    const createEntityForm = document.getElementById('createEntityForm');
    const modal = document.getElementById('createEntityModal');
    const searchInput = document.getElementById('searchInput');
    const entitiesTableBody = document.getElementById('entitiesTableBody');
    const formError = document.getElementById('formError');

    // Initialize pagination
    filteredRows = Array.from(document.querySelectorAll('.entity-row'));
    updatePagination();

    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const allRows = document.querySelectorAll('.entity-row');

            filteredRows = Array.from(allRows).filter(row => {
                const name = row.getAttribute('data-entity-name');
                const description = row.getAttribute('data-entity-description');
                return name.includes(searchTerm) || description.includes(searchTerm);
            });

            currentPage = 1;
            updatePagination();
        });
    }

    function updatePagination() {
        const totalRows = filteredRows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, totalRows);

        // Update info text
        document.getElementById('totalEntities').textContent = totalRows;
        document.getElementById('startIndex').textContent = totalRows > 0 ? startIndex + 1 : 0;
        document.getElementById('endIndex').textContent = endIndex;

        // Hide all rows first
        const allRows = document.querySelectorAll('.entity-row');
        allRows.forEach(row => row.style.display = 'none');

        // Show only filtered and paginated rows
        for (let i = startIndex; i < endIndex; i++) {
            filteredRows[i].style.display = '';
        }

        // Update pagination controls
        updatePaginationControls(totalPages);
    }

    function updatePaginationControls(totalPages) {
        const paginationControls = document.getElementById('paginationControls');
        if (!paginationControls) return;

        paginationControls.innerHTML = '';

        if (totalPages <= 1) return;

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
        if (currentPage > 1) {
            prevLi.querySelector('a').addEventListener('click', (e) => {
                e.preventDefault();
                currentPage--;
                updatePagination();
            });
        }
        paginationControls.appendChild(prevLi);

        // Page numbers (show max 5 pages at a time)
        const maxPagesToShow = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage < maxPagesToShow - 1) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            const pageNum = i;
            pageLi.querySelector('a').addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = pageNum;
                updatePagination();
            });
            paginationControls.appendChild(pageLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
        if (currentPage < totalPages) {
            nextLi.querySelector('a').addEventListener('click', (e) => {
                e.preventDefault();
                currentPage++;
                updatePagination();
            });
        }
        paginationControls.appendChild(nextLi);
    }

    // Create entity functionality
    createEntityBtn.addEventListener('click', async function() {
        const nameInput = document.getElementById('name');
        const descriptionInput = document.getElementById('description');
        const name = nameInput.value.trim();
        const description = descriptionInput.value.trim();

        // Validate
        if (!name) {
            showError('Entity name is required');
            return;
        }

        // Hide error if shown
        formError.classList.add('d-none');

        // Show loading state
        createEntityBtn.disabled = true;
        createEntityBtn.querySelector('.btn-text').classList.add('d-none');
        createEntityBtn.querySelector('.btn-spinner').classList.remove('d-none');

        // Close modal
        const modalInstance = bootstrap.Modal.getInstance(modal);
        if (modalInstance) {
            modalInstance.hide();
        }

        // Reset form
        createEntityForm.reset();

        try {
            // Make AJAX request
            const response = await fetch('{{ url_for("create_entity") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    name: name,
                    description: description
                })
            });

            const data = await response.json();

            if (data.success) {
                // Reload the page to show the new entity with metrics
                window.location.reload();
            } else {
                showError(data.error || 'Failed to create entity');
            }
        } catch (error) {
            console.error('Error creating entity:', error);
            showError('Failed to create entity. Please try again.');
        } finally {
            // Reset button state
            createEntityBtn.disabled = false;
            createEntityBtn.querySelector('.btn-text').classList.remove('d-none');
            createEntityBtn.querySelector('.btn-spinner').classList.add('d-none');
        }
    });

    function showError(message) {
        formError.textContent = message;
        formError.classList.remove('d-none');
    }

    // Reset form and error when modal is closed
    modal.addEventListener('hidden.bs.modal', function() {
        createEntityForm.reset();
        formError.classList.add('d-none');
    });
});
</script>
{% endblock %}
